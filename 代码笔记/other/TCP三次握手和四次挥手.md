## 三次握手

所谓三次握手，即建立 TCP 连接时，需要客户端和服务端总共发送三个包以确认连接的建立

### 第一次握手

客户端发送连接请求的消息给服务端

此时客户端并不知道服务端是否接到了请求，客户端开始等待

### 第二次握手

服务端收到客户端的连接请求消息，对客户端进行应答，表示同意连接

这时服务端不知道客户端是否接到了消息，服务端开始等待

### 第三次握手

收到服务端的连接同意消息后，给服务端发一个确认收到的消息

客户端发送完后便进入 ESTABLISHED（已确立的）状态

服务端收到这个应答后也进入 ESTABLISHED 状态，此时连接的建立完成

### 为什么不是两次握手

客户端发出的第一个连接请求因为网络原因长时间滞留了，已延误到连接释放后才到达服务端

服务端就误以为是客户端新的请求，于是就向客户端发送确认消息，同意建立连接

由于客户端没发送请求，因此不会理会服务端的确认，也不会发数据给服务端

服务端却以为连接已经建立，并一直等待客户端的数据，这样就会浪费很多资源

---

## 四次挥手

所谓四次挥手，即数据传输完毕，进行 TCP 连接的释放

### 第一次挥手

客户端已经没有数据要传给服务端了，发出取消连接的消息给服务端

客户端开始进入等待状态

### 第二次挥手

服务端接收到消息，回应客户端，表示已经收到断开请求

### 第三次挥手

服务端在回复客户端后，不会马上断开 TCP 连接

服务端会先确认断开前，所有传输到客户端的数据是否已经传输完毕

当确认所有数据都已传完后，向客户端发送表示可以断开的消息

服务端开始等待

### 第四次挥手

客户端收到消息后，再发送给服务端，表示同意断开连接

再等 2 MSL 时间后就真正断开了连接

（MSL：Maximum Segment Lifetime，即最大报文生存时间，四分钟）

### 为什么要等 2 MSL

为了保证客户端最后一次挥手的报文能够到达服务器，如果第四次挥手的报文段丢失了，服务器会超时重传这个第三次挥手的报文段，所以客户端不是直接进入 CLOSED，而是要保持 TIME_WAIT（等待 2MSL 就是 TIME_WAIT）就起到作用了

当再次收到服务器的超时重传的断开连接的第三次挥手的请求的时候，客户端会继续给服务器发送一个第四次挥手的报文，能够保证对方（服务器）收到客户端的回应报文，最后客户端和服务器正确的关闭连接

### 参考

http://dy.163.com/v2/article/detail/EENRSF0705315U6Q.html